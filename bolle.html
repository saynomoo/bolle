<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
        PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>Bolle - pompi maaliin!</title>
    <script type="text/javascript" src="jquery-1.4.2.js"></script>
    <script type="text/javascript" src="jquery.easing.1.3.js"></script>
    <script type="text/javascript" src="jquery.gamequery-0.4.0.js"></script>
    <script type="text/javascript" src="jquery.collisioncheck-1.1.min.js"></script>
    <script type="text/javascript" src="bolle.js"></script>
    <script type="text/javascript">
        $(function(){
            var PLAYGROUND_HEIGHT = 250;
            var PLAYGROUND_WIDTH = 700;

            var playground = $("#playground").playground({height: PLAYGROUND_HEIGHT, width: PLAYGROUND_WIDTH});
            playground.addGroup("background", {width: PLAYGROUND_WIDTH, height: PLAYGROUND_HEIGHT});
            playground.addGroup("ground", {width: PLAYGROUND_WIDTH, height: PLAYGROUND_HEIGHT});
            playground.addGroup("foreground", {width: PLAYGROUND_WIDTH, height: PLAYGROUND_HEIGHT});
            playground.addGroup("ball", {width: 50, height: 50});

            var background1 = new $.gameQuery.Animation({imageURL: "cave-background.png", type: 1});
            $("#background").addSprite("background1", {animation: background1, width: PLAYGROUND_WIDTH*10, height: 250});

            var ground1 = new $.gameQuery.Animation({imageURL: "cave-ground.png", type: 1});
            $("#ground").addSprite("ground1", {animation: ground1, width: PLAYGROUND_WIDTH*30, height: 50, posy: PLAYGROUND_HEIGHT - 50});

            var ball1 = new $.gameQuery.Animation({imageURL: "red_ball.png"});
            $("#ball").addSprite("ball1", {animation: ball1, width: 50, height: 50, posy: PLAYGROUND_HEIGHT - 75, posx: PLAYGROUND_WIDTH/2 - 12});

            var foreground1 = new $.gameQuery.Animation({imageURL: "rocks.png", type: 1});
            $("#foreground").addSprite("foreground1", {animation: foreground1, width: PLAYGROUND_WIDTH*2, height: 25, posy: PLAYGROUND_HEIGHT - 25});

            var smaragds = [500, 1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000, 9000, 9200, 9400, 9600, 9800];
            var smaragdAnimation = new $.gameQuery.Animation({imageURL: "smaragd.png"});
            for(var i in smaragds){
                var xpos = smaragds[i];
                $("#ground").addSprite("smaragd_" + xpos, {animation: smaragdAnimation, width: 32, height: 32, posy: PLAYGROUND_HEIGHT - 150, posx: xpos});
                $("#smaragd_" + xpos).addClass("smaragd");
            }
            var bugAnimation = new $.gameQuery.Animation({imageURL: "bug.png"});
            var bugs = [730, 1350, 2350, 3350, 4350, 5000, 5500, 6000, 6500, 7000, 7500, 8000, 8500, 8900, 9300, 9700, 10000];
            for(var b in bugs){
                var bxpos = bugs[b];
                $("#ground").addSprite("bug_" + bxpos, {animation: bugAnimation, width: 32, height: 32, posy: PLAYGROUND_HEIGHT - 64, posx: bxpos});
                $("#bug_" + bxpos).addClass("bug");
            }

            var balle = new function(){
                this.x = 0;
                this.offsetX = function(){
                    return balle.movingLeft ? -1 : balle.movingRight ? 1 : 0;
                };
                this.onTheFloor = true;
                this.movingLeft = false;
                this.movingRight = false;
                this.jump = function(){
                    if(this.onTheFloor){
                        this.onTheFloor = false;
                        $("#ball").animate({top: "-=150"}, 1000, "easeOutCirc", function(){
                            $("#ball").animate({top: "+=150"}, 1000, "easeInCirc", function(){
                                balle.onTheFloor = true;
                            })
                        })
                    }
                }
            };

            $(document).keydown(function(e){
              switch(e.keyCode){
                case 37: //this is left! (a)
                  balle.movingLeft = true;
                  break;
                case 39: //this is right (d)
                    balle.movingRight = true;
                  break;
              }
            });
            $(document).keyup(function(e){
              switch(e.keyCode){
                case 37: //this is left! (a)
                    balle.movingLeft = false;
                  break;
                case 39: //this is right (d)
                    balle.movingRight = false;
                  break;
                case 32: //space
                  balle.jump();
                  break;
              }
            });
            var moveLayers = function(){
                balle.x += balle.offsetX();
                if(balle.x<0)balle.x=0;
                $("#background").css("left", -balle.x);
                $("#ground").css("left", -balle.x*3);
                $("#foreground").css("left", -balle.x*9 % PLAYGROUND_WIDTH);
            };
            var smaragdCollisionDetection = function(){
              $("#ball1").collidesWith("#ground .smaragd").each(function(){
                  $(this).hide();
              });
            };
            var moveBugs = function(){
              $("#playground").collidesWith("#ground .bug").each(function(){
                  var ele = $(this);
                  ele.css("left", parseFloat(ele.css("left"))-2.5);
              })
            };
            var bugCollisionDetection = function(){
                $("#ball1").collidesWith("#ground .bug").each(function(){
                    $(this).hide();
                });
            };
            var advanceTheWorld = function(){
                if(balle.offsetX()!=0){
                    moveLayers();
                }
                smaragdCollisionDetection();
                moveBugs();
                bugCollisionDetection();
            };
            playground.registerCallback(advanceTheWorld, 30);
            playground.startGame();
        });


    </script>
</head>
<body>
<div id="playground"></div>
<!--<div id="debugconsol" style="position: absolute; bottom: 5px; width: 600px; height: 100px; background: #ddd; overflow: auto;"></div></body>-->
</body>
</html>